<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Sender</title>
    <link rel="stylesheet" href="style.css">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div class="column">
            <br><br>
            <strong>Input peer id</strong>
            <input type="text" id="remoteId" placeholder="Peer id ">
            <button class="btn btn-primary" id="connectBtn">Connect</button>
            <br><br>
            <p id="status">Status: </p>
            <br><br><br>
            <button class="btn btn-primary" id="callBtn">Call</button>
            <button id="cameraBtn" class="btn btn-warning">Open Cam</button>
            <button id="hangupBtn" class="btn btn-warning">Hang Up</button>

            <div id="videos">
                <video id="localVideo" muted autoplay playsinline></video>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>

        </div>
    </div>
    </div>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
</body>

<script>
    var localStream = null;
    var remoteStream = null;

    var cameraBtn = document.querySelector('#cameraBtn');
    var hangupBtn = document.querySelector('#hangupBtn');
    var callBtn = document.querySelector('#callBtn');
    var connectBtn = document.querySelector('#connectBtn');

    var lastPeerId = null;
    var peer = null;
    var conn = null;
    var mediaConn = null ; 
    var remoteConnection = null;
    function init() {
        cameraBtn.addEventListener('click', getMedia);
        hangupBtn.addEventListener('click', hangUp);
        connectBtn.addEventListener('click', connectPeer);

        callBtn.addEventListener('click', startCall);
        hangupBtn.disabled = true;
        cameraBtn.disabled = false;
        callBtn.disabled = true;
        peerInit();
    };
    //Data connection 
    function connectPeer() {
        if (conn) { conn.close(); }
        var remoteId = document.querySelector("#remoteId");
        conn = peer.connect(remoteId.value, { reliable: true });
        conn.on('open', function () {
            document.querySelector("#status").innerHTML = "Connected to: " + conn.peer;
            console.log("Connected" + conn.peer);
        })
    }
    async function getMedia(e) {
        const stream = await navigator.mediaDevices.getUserMedia(
            { video: true, audio: true });
        localStream = stream;
        remoteStream = new MediaStream();
        //Stream the video live feed to the html DOM 
        document.querySelector('#localVideo').srcObject = stream;
        hangupBtn.disabled = false;
        cameraBtn.disabled = true;
        callBtn.disabled = false;
    };
    async function hangUp(e) {
        const tracks = document.querySelector("#localVideo").srcObject.getTracks();
        tracks.forEach(track => { track.stop(); });
        if (remoteStream) {
            remoteStream.getTracks().forEach(track => track.stop());
        }
        hangupBtn.disabled = true;
        cameraBtn.disabled = false;
        //Close peer connection below 
    }
    function startCall() {
        if (remoteId != null || cameraBtn.disabled === false) {
            var call = peer.call(remoteId.value, localStream);
            call.on('stream',
                function (stream) {
                    remoteStream = stream;
                    document.querySelector("#remoteVideo").srcObject = remoteStream;
                }, (err) => console.log(err));
        } else { alert("You have to open mic or enter peer id") }
    }
    //Connect to remote peer 
    function peerInit() {
        peer = new Peer();
        peer.on("open",
            function (id) {
                if (peer.id === null) {
                    console.log("Receive null peerid");
                    id = lastPeerId;
                } else {
                    lastPeerId = id;
                }
                console.log(id);
            }, (err) => console.log("failed to connect to server"));

        peer.on('connection', function (c) {
            // Disallow incoming connections
            c.on('open', function () {
                c.send("Sender does not accept incoming connections");
                setTimeout(function () { c.close(); }, 500);
            });
        });
    }
    init();
</script>

</html>